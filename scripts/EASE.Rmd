---
title: "EASE"
author: "Kate Mills"
date: "10/18/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE
)
```

Load required packages and scripts (no input needed)
```{r setup, include=FALSE}
packages <- c( "tidyverse","ggmap")
if (length(setdiff(packages, rownames(installed.packages()))) > 0) {
  install.packages(setdiff(packages, rownames(installed.packages())))
}
lapply(packages, library, character.only = TRUE)

# Kate's custom theme
theme_kate <- function () { 
    theme_bw() +
  theme_minimal(base_size = 14, base_family = "Avenir") +
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        legend.position="bottom")
}

workdir=as.character(read.table((paste0(getwd(),"/org/workdir.txt")))[[1]])
```

Geolocation data
```{r}
# Generate list of subs
subs<-list.files(path = paste0(workdir,"Data_Winter2017/"))

# Remove sub 21 because of some error in reading data & final entry
subs<-subs[-21]
subs<-subs[-23]

# Extract geolocation data
extract_geo=function(sub){
  files<-list.files(path=paste0(workdir,"Data_Winter2017/",sub,"/"),pattern = "log.decrypted")
  output<-lapply(X = files,FUN = function(file){
    if (nchar(read.csv(paste0(workdir,"Data_Winter2017/",sub,"/",file),
                       header = FALSE,sep = " ",stringsAsFactors = FALSE)$V5[[1]])>11){
      geooutput<-read.csv(paste0(workdir,"Data_Winter2017/",sub,"/",file),
                          header = FALSE,
                          sep = " ",
                          col.names = paste0("V",seq_len(200)),
                          stringsAsFactors = FALSE,
                          fill = TRUE) %>%
        select(V1,V2,V4,V5,V7) %>%
        mutate(startdate=substring(V1,3,last=nchar(V1)),
               starttime=substring(V2,1,last=(nchar(V2)-1)),
               enddate=substring(V4,2,last=nchar(V4)),
               endtime=substring(V5,1,last=8),
               lat=substring(V5,first=12,last=nchar(V5)),
               lon=substring(V7,first=1,last=(nchar(V7)-1))) %>%
        select(-contains("V"))
      geooutput
    }
  })
  output.df<-data.table::rbindlist(output, fill=TRUE)
  output.df
  if (nrow(output.df)>0){cbind(sub,output.df)
  } else {
    output<-cbind(sub,NA,NA,NA,NA,NA,NA)
    colnames(output)<-c("sub","startdate","starttime","enddate","endtime","lat","lon")
    output.df<-as.data.frame(output)
    output.df
  }
}
extract_geo_out<-lapply(subs,extract_geo)
extract_geo_out.df<-as.data.frame(do.call(rbind,extract_geo_out))
extract_geo_out.df<-na.omit(extract_geo_out.df)

subs_with_geo<-unique(extract_geo_out.df$sub)
print(paste0("There are ",length(subs_with_geo)," EASE participants with geolocation data"))
```

Analyze geolocation data
```{r}
testdata<-extract_geo_out.df %>%
  mutate(lon=as.numeric(levels(lon)[lon]),
         lat=as.numeric(levels(lat)[lat])) %>%
  filter(!lat==0,!lon==0) %>%
  select(lon,lat,sub)

# first test of making maps
testmap<- get_map(location = "Eugene", zoom = 14,
                      maptype = "satellite", scale = 2)
ggmap(testmap) +
  # geom_point(data = testdata,
  #            aes(x = lon, y = lat, size = sub,
  #                colour = sub,
  #                alpha = 0.8)) + 
  # geom_path(data = testdata, aes(colour=sub),size = 1, lineend = "round") + 
  #scale_color_gradient(colours = rainbow(7), breaks = seq(25, 200, by = 25))+
  stat_density2d(aes(x = lon, y = lat, 
  fill = ..level.. , alpha = ..level..),size = 2, bins = 4, 
  data =(testdata[1000:4000,]), geom = 'polygon') +
  scale_alpha(range = c(.8, 1), guide = FALSE) +
  guides(fill = guide_colorbar(barwidth = 1.5, barheight = 10)) +
  theme(legend.position="none")

```

Text data
```{r}
# Generate list of subs
subs<-list.files(path = paste0(workdir,"Data_Fall2016/"))

# Extract text data
extract_txt=function(sub){
  files<-list.files(path=paste0(workdir,"Data_Fall2016/",sub,"/"),pattern = "log.decrypted")
  output<-lapply(X = files,FUN = function(textfile){
    textoutput<-read.csv(paste0(workdir,"Data_Fall2016/",sub,"/",textfile),
                         header = FALSE,sep = " ",stringsAsFactors = FALSE)
    textoutput})
  output.df<-data.table::rbindlist(output, fill=TRUE)
  cbind(sub,output.df)
}
extract_txt_out<-lapply(subs,extract_txt)
extract_txt_out.df<-as.data.frame(do.call(rbind,extract_txt_out))
```